image: Ubuntu2004
build: off

environment:
  # enable taylor to ssh to appveyor vm
  APPVEYOR_SSH_KEY: ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIFp48yQviDu3U2mGdwv7CO3O84IAj4LJUXzyGbs6mT0q taylor

init:
- sh: curl -sflL https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-ssh.sh | bash -e -
on_failure:
- echo Sleeping to allow debug
# - sleep 60m

install:
- sudo ufw status
- sudo ufw disable
- sudo ufw status
- sudo apt-get -qq update
- sudo snap install core
- sudo apt-get -y install apparmor apparmor-utils auditd apparmor-profiles apparmor-profiles-extra lxc debootstrap squashfs-tools awscli >/dev/null
- sudo snap install distrobuilder --classic >/dev/null
- sudo bash -x dns.sh
- sudo lxd init --auto
- sudo lxc launch images:rockylinux/8 rocky -c security.privileged=true
- sudo lxc config device add rocky homedir disk source=$(pwd) path=/tmp/test
- sudo lxc network set lxdbr0 raw.dnsmasq dhcp-option=6,8.8.8.8,8.8.4.4
- sudo lxc exec rocky -- echo nameserver 8.8.8.8 | sudo tee -a /etc/resolv.conf
- sudo lxc exec rocky -- echo hello
- sudo lxc exec rocky -- bash -xe /tmp/test/test.sh
